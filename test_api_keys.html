<!DOCTYPE html>
<html>
<head>
    <title>API Key Storage Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { margin: 5px; padding: 8px 16px; }
    </style>
</head>
<body>
    <h1>API Key Persistence Test</h1>
    
    <div id="results"></div>
    
    <button onclick="testSaveLoad()">Test Save/Load</button>
    <button onclick="testClear()">Test Clear</button>
    <button onclick="checkExisting()">Check Existing Keys</button>
    
    <script>
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = `test ${isError ? 'error' : 'success'}`;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            document.getElementById('results').appendChild(div);
        }
        
        function testSaveLoad() {
            try {
                // Test data
                const testKeys = {
                    openai: 'sk-test-openai-key-12345',
                    gemini: 'gemini-test-key-67890',
                    claude: 'claude-test-key-abcde',
                    betfair: 'betfair-test-key-fghij',
                    weather: 'weather-test-key-klmno'
                };
                
                // Save to localStorage
                const encryptedKeys = btoa(JSON.stringify(testKeys));
                localStorage.setItem('wicketwise_api_keys', encryptedKeys);
                localStorage.setItem('wicketwise_keys_timestamp', new Date().toISOString());
                
                log('‚úÖ Test keys saved to localStorage');
                
                // Load from localStorage
                const savedEncrypted = localStorage.getItem('wicketwise_api_keys');
                const savedKeys = JSON.parse(atob(savedEncrypted));
                const timestamp = localStorage.getItem('wicketwise_keys_timestamp');
                
                // Verify
                if (JSON.stringify(testKeys) === JSON.stringify(savedKeys)) {
                    log('‚úÖ Save/Load test passed - keys match perfectly');
                    log(`üìÖ Timestamp: ${timestamp}`);
                } else {
                    log('‚ùå Save/Load test failed - keys do not match', true);
                }
                
            } catch (error) {
                log(`‚ùå Save/Load test error: ${error.message}`, true);
            }
        }
        
        function testClear() {
            try {
                localStorage.removeItem('wicketwise_api_keys');
                localStorage.removeItem('wicketwise_keys_timestamp');
                
                const check = localStorage.getItem('wicketwise_api_keys');
                if (check === null) {
                    log('‚úÖ Clear test passed - keys removed from localStorage');
                } else {
                    log('‚ùå Clear test failed - keys still exist', true);
                }
                
            } catch (error) {
                log(`‚ùå Clear test error: ${error.message}`, true);
            }
        }
        
        function checkExisting() {
            try {
                const existing = localStorage.getItem('wicketwise_api_keys');
                const timestamp = localStorage.getItem('wicketwise_keys_timestamp');
                
                if (existing) {
                    const keys = JSON.parse(atob(existing));
                    log(`üîë Found existing keys: ${Object.keys(keys).join(', ')}`);
                    log(`üìÖ Saved: ${timestamp}`);
                    
                    // Show partial key values (first 10 chars)
                    Object.entries(keys).forEach(([service, key]) => {
                        const partial = key ? key.substring(0, 10) + '...' : 'empty';
                        log(`  ${service}: ${partial}`);
                    });
                } else {
                    log('üì≠ No existing API keys found in localStorage');
                }
                
            } catch (error) {
                log(`‚ùå Check existing error: ${error.message}`, true);
            }
        }
        
        // Auto-check on load
        checkExisting();
    </script>
</body>
</html>