<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WicketWise - Betting Intelligence</title>
    
    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #fbbf24;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Player Card */
        .player-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .player-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 20px;
            border: 3px solid #fbbf24;
        }

        .player-info h2 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .player-info .teams {
            color: #94a3b8;
            font-size: 1.1em;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #fbbf24;
        }

        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e3c72;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 95%;
            max-width: 1100px;
            height: 90vh;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            background: rgba(251, 191, 36, 0.1);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #fbbf24;
            font-size: 1.5em;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 30px;
            height: calc(90vh - 80px);
            overflow-y: auto;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-button.active {
            background: #fbbf24;
            color: #1e3c72;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Betting Markets */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .market-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #fbbf24;
        }

        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .market-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .ev-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .ev-positive {
            background: #10b981;
            color: white;
        }

        .ev-negative {
            background: #ef4444;
            color: white;
        }

        .market-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .market-stat {
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .market-stat .value {
            font-weight: bold;
            color: #fbbf24;
        }

        .market-stat .label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .recommendation {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .recommendation.avoid {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        /* Chat Interface */
        .chat-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 500px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }

        .chat-header {
            background: rgba(251, 191, 36, 0.1);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
        }

        .message.user {
            text-align: right;
        }

        .message.ai {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: #fbbf24;
            color: #1e3c72;
        }

        .message.ai .message-bubble {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-input button {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: #fbbf24;
            color: #1e3c72;
            cursor: pointer;
            font-weight: bold;
        }

        /* Quick Questions */
        .quick-questions {
            margin-bottom: 20px;
        }

        .quick-questions h4 {
            margin-bottom: 10px;
            color: #fbbf24;
        }

        .question-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .question-chip {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .question-chip:hover {
            background: #fbbf24;
            color: #1e3c72;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-container {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }
            
            .modal-content {
                width: 98%;
                height: 95vh;
                margin: 1% auto;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏏 WicketWise Betting Intelligence</h1>
            <p>Professional Cricket Betting Analysis & AI Insights</p>
        </div>

        <div class="player-card" id="playerCard">
            <div class="player-header">
                <img src="" alt="Player" class="player-avatar" id="playerAvatar">
                <div class="player-info">
                    <h2 id="playerName">Loading...</h2>
                    <div class="teams" id="playerTeams">Teams loading...</div>
                </div>
            </div>
            
            <div class="quick-stats" id="quickStats">
                <!-- Stats will be loaded dynamically -->
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openBettingDetails()">
                    📊 View Betting Details
                </button>
                <button class="btn btn-secondary" onclick="openAIChat()">
                    🤖 Ask AI
                </button>
            </div>
        </div>
    </div>

    <!-- Betting Details Modal -->
    <div id="bettingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎯 Betting Intelligence Dashboard</h2>
                <span class="close" onclick="closeBettingDetails()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tab-nav">
                    <button class="tab-button active" onclick="switchTab('markets')">Markets & Odds</button>
                    <button class="tab-button" onclick="switchTab('analysis')">Risk Analysis</button>
                    <button class="tab-button" onclick="switchTab('recommendations')">Recommendations</button>
                    <button class="tab-button" onclick="switchTab('trends')">Form & Trends</button>
                </div>

                <!-- Markets Tab -->
                <div id="marketsTab" class="tab-content active">
                    <div class="quick-questions">
                        <h4>💡 Quick Analysis</h4>
                        <div class="question-chips">
                            <div class="question-chip" onclick="askQuickQuestion('What are the best runs bets?')">Best Runs Bets</div>
                            <div class="question-chip" onclick="askQuickQuestion('Should I back boundaries?')">Boundaries Value</div>
                            <div class="question-chip" onclick="askQuickQuestion('Strike rate opportunities?')">Strike Rate</div>
                            <div class="question-chip" onclick="askQuickQuestion('Risk assessment?')">Risk Level</div>
                        </div>
                    </div>
                    
                    <div class="market-grid" id="marketGrid">
                        <!-- Markets will be loaded dynamically -->
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div id="analysisTab" class="tab-content">
                    <div id="riskAnalysis">
                        <!-- Risk analysis will be loaded dynamically -->
                    </div>
                </div>

                <!-- Recommendations Tab -->
                <div id="recommendationsTab" class="tab-content">
                    <div id="bettingRecommendations">
                        <!-- Recommendations will be loaded dynamically -->
                    </div>
                </div>

                <!-- Trends Tab -->
                <div id="trendsTab" class="tab-content">
                    <div id="formTrends">
                        <!-- Trends will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Interface -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <h3>🤖 Betting AI Assistant</h3>
            <span class="close" onclick="closeAIChat()">&times;</span>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-bubble">
                    Hi! I'm your betting intelligence assistant. Ask me anything about this player's betting opportunities, form analysis, or market insights!
                </div>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask about betting opportunities..." 
                   onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Global variables
        let currentPlayer = null;
        let bettingIntelligence = null;
        const API_BASE = 'http://127.0.0.1:5005';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultPlayer();
        });

        async function loadDefaultPlayer() {
            // Check if player is specified in URL
            const urlParams = new URLSearchParams(window.location.search);
            const playerFromUrl = urlParams.get('player');
            
            const defaultPlayer = playerFromUrl || 'MS Dhoni';
            console.log(`🏏 Loading player: ${defaultPlayer} ${playerFromUrl ? '(from URL)' : '(default)'}`);
            
            await loadPlayerData(defaultPlayer);
        }

        async function loadPlayerData(playerName) {
            try {
                console.log(`🏏 Loading betting data for ${playerName}...`);
                
                // Load player card data
                console.log('📡 Fetching card data from API...');
                const cardResponse = await fetch(`${API_BASE}/api/cards/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        player_name: playerName,
                        persona: 'betting'
                    })
                });

                console.log('📡 Card response status:', cardResponse.status);
                
                if (!cardResponse.ok) {
                    throw new Error(`HTTP error! status: ${cardResponse.status}`);
                }

                const cardData = await cardResponse.json();
                console.log('✅ Card data loaded:', cardData);

                // Load betting intelligence
                console.log('🎯 Fetching betting intelligence...');
                const bettingResponse = await fetch(`${API_BASE}/api/betting/intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        player_name: playerName,
                        player_stats: cardData
                    })
                });

                console.log('🎯 Betting response status:', bettingResponse.status);

                let bettingData = null;
                if (bettingResponse.ok) {
                    bettingData = await bettingResponse.json();
                    console.log('✅ Betting intelligence loaded from API:', bettingData);
                } else {
                    console.warn('⚠️ Betting intelligence not available from API, using mock data');
                    bettingData = generateMockBettingData(playerName, cardData);
                    console.log('✅ Mock betting data generated:', bettingData);
                }

                currentPlayer = cardData;
                bettingIntelligence = bettingData;

                updatePlayerCard(cardData);
                
            } catch (error) {
                console.error('Error loading player data:', error);
                // Load with mock data
                const mockData = generateMockPlayerData(playerName);
                currentPlayer = mockData;
                bettingIntelligence = generateMockBettingData(playerName, mockData);
                updatePlayerCard(mockData);
            }
        }

        function generateMockPlayerData(playerName) {
            return {
                player_name: playerName,
                batting_avg: 32.5,
                strike_rate: 125.8,
                matches_played: 156,
                teams: ['Chennai Super Kings', 'India'],
                form_rating: 72.0,
                profile_image_url: `https://ui-avatars.com/api/?name=${playerName.replace(' ', '+')}&background=fbbf24&color=1e3c72&size=80`
            };
        }

        function generateMockBettingData(playerName, playerStats) {
            return {
                player_name: playerName,
                form_rating: playerStats.form_rating || 72.0,
                volatility: 15.2,
                consistency_score: 78.5,
                risk_assessment: 'Medium',
                markets: [
                    {
                        market_type: 'runs_over_25.5',
                        line: 25.5,
                        over_odds: 1.85,
                        under_odds: 1.95,
                        model_probability: 0.658,
                        market_probability: 0.541,
                        expected_value: 0.123,
                        confidence: 0.78,
                        volume: 125000
                    },
                    {
                        market_type: 'boundaries_over_4.5',
                        line: 4.5,
                        over_odds: 2.10,
                        under_odds: 1.75,
                        model_probability: 0.445,
                        market_probability: 0.476,
                        expected_value: -0.065,
                        confidence: 0.65,
                        volume: 85000
                    },
                    {
                        market_type: 'strike_rate_over_120.5',
                        line: 120.5,
                        over_odds: 1.92,
                        under_odds: 1.88,
                        model_probability: 0.580,
                        market_probability: 0.521,
                        expected_value: 0.091,
                        confidence: 0.72,
                        volume: 95000
                    }
                ],
                betting_recommendations: [
                    {
                        market: 'runs_over_25.5',
                        recommendation: 'BACK Over 25.5',
                        odds: 1.85,
                        expected_value: '+12.3%',
                        confidence: 'High',
                        reasoning: 'excellent recent form (+15% edge), consistent performer (low risk)',
                        stake_suggestion: 'Medium stake (1-2% bankroll)',
                        risk_level: 'Low'
                    }
                ],
                recent_trends: {
                    last_5_matches_avg: 28.4,
                    powerplay_performance: 'Improving',
                    death_overs_performance: 'Strong',
                    vs_pace_trend: 'Positive',
                    vs_spin_trend: 'Positive'
                }
            };
        }

        function updatePlayerCard(playerData) {
            document.getElementById('playerName').textContent = playerData.player_name;
            document.getElementById('playerTeams').textContent = playerData.teams ? playerData.teams.join(', ') : 'Teams not available';
            document.getElementById('playerAvatar').src = playerData.profile_image_url || `https://ui-avatars.com/api/?name=${playerData.player_name.replace(' ', '+')}&background=fbbf24&color=1e3c72&size=80`;

            const quickStats = document.getElementById('quickStats');
            quickStats.innerHTML = `
                <div class="stat-box">
                    <div class="value">${playerData.batting_avg || 'N/A'}</div>
                    <div class="label">Batting Average</div>
                </div>
                <div class="stat-box">
                    <div class="value">${playerData.strike_rate || 'N/A'}</div>
                    <div class="label">Strike Rate</div>
                </div>
                <div class="stat-box">
                    <div class="value">${playerData.matches_played || 'N/A'}</div>
                    <div class="label">Matches</div>
                </div>
                <div class="stat-box">
                    <div class="value">${playerData.form_rating || 'N/A'}/100</div>
                    <div class="label">Form Rating</div>
                </div>
            `;
        }

        function openBettingDetails() {
            console.log('🔍 Opening betting details...');
            console.log('Betting intelligence loaded:', !!bettingIntelligence);
            
            if (!bettingIntelligence) {
                console.error('❌ Betting intelligence not loaded yet');
                alert('Betting intelligence not loaded yet. Please wait...');
                return;
            }

            console.log('✅ Loading betting tabs...');
            loadBettingTabs();
            document.getElementById('bettingModal').style.display = 'block';
            console.log('✅ Modal should be visible now');
        }

        function closeBettingDetails() {
            document.getElementById('bettingModal').style.display = 'none';
        }

        function loadBettingTabs() {
            loadMarketsTab();
            loadAnalysisTab();
            loadRecommendationsTab();
            loadTrendsTab();
        }

        function loadMarketsTab() {
            const marketGrid = document.getElementById('marketGrid');
            
            if (!bettingIntelligence || !bettingIntelligence.markets) {
                marketGrid.innerHTML = '<p>No betting markets available</p>';
                return;
            }

            marketGrid.innerHTML = bettingIntelligence.markets.map(market => `
                <div class="market-card">
                    <div class="market-header">
                        <div class="market-title">${market.market_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                        <div class="ev-badge ${market.expected_value > 0 ? 'ev-positive' : 'ev-negative'}">
                            EV: ${market.expected_value > 0 ? '+' : ''}${(market.expected_value * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div class="market-details">
                        <div class="market-stat">
                            <div class="value">${market.line}</div>
                            <div class="label">Line</div>
                        </div>
                        <div class="market-stat">
                            <div class="value">${market.over_odds}</div>
                            <div class="label">Over Odds</div>
                        </div>
                        <div class="market-stat">
                            <div class="value">${(market.model_probability * 100).toFixed(1)}%</div>
                            <div class="label">Our Model</div>
                        </div>
                        <div class="market-stat">
                            <div class="value">${(market.market_probability * 100).toFixed(1)}%</div>
                            <div class="label">Market</div>
                        </div>
                    </div>
                    <div class="recommendation ${market.expected_value < 0 ? 'avoid' : ''}">
                        <strong>${market.expected_value > 0 ? '✅ BACK' : '❌ AVOID'}</strong> Over ${market.line}
                        <br>Confidence: ${(market.confidence * 100).toFixed(0)}% | Volume: £${market.volume.toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        function loadAnalysisTab() {
            const analysisDiv = document.getElementById('riskAnalysis');
            
            if (!bettingIntelligence) return;

            analysisDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="stat-box" style="padding: 20px;">
                        <div class="value">${bettingIntelligence.form_rating}/100</div>
                        <div class="label">Form Rating</div>
                    </div>
                    <div class="stat-box" style="padding: 20px;">
                        <div class="value">${bettingIntelligence.volatility}</div>
                        <div class="label">Volatility (σ)</div>
                    </div>
                    <div class="stat-box" style="padding: 20px;">
                        <div class="value">${bettingIntelligence.consistency_score}/100</div>
                        <div class="label">Consistency</div>
                    </div>
                    <div class="stat-box" style="padding: 20px;">
                        <div class="value">${bettingIntelligence.risk_assessment}</div>
                        <div class="label">Risk Level</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                    <h3 style="color: #fbbf24; margin-bottom: 15px;">📈 Risk Assessment</h3>
                    <p><strong>Volatility Analysis:</strong> σ=${bettingIntelligence.volatility} indicates ${bettingIntelligence.risk_assessment.toLowerCase()} risk betting opportunities.</p>
                    <p><strong>Consistency Score:</strong> ${bettingIntelligence.consistency_score}/100 suggests ${bettingIntelligence.consistency_score > 75 ? 'highly predictable' : bettingIntelligence.consistency_score > 50 ? 'moderately predictable' : 'unpredictable'} performance patterns.</p>
                    <p><strong>Form Context:</strong> Current form rating of ${bettingIntelligence.form_rating}/100 ${bettingIntelligence.form_rating > 70 ? 'strongly favors backing' : bettingIntelligence.form_rating > 50 ? 'suggests cautious backing' : 'advises laying or avoiding'} this player.</p>
                </div>
            `;
        }

        function loadRecommendationsTab() {
            const recDiv = document.getElementById('bettingRecommendations');
            
            if (!bettingIntelligence || !bettingIntelligence.betting_recommendations) return;

            recDiv.innerHTML = bettingIntelligence.betting_recommendations.map((rec, index) => `
                <div class="market-card" style="margin-bottom: 20px;">
                    <div class="market-header">
                        <div class="market-title">💰 Recommendation #${index + 1}</div>
                        <div class="ev-badge ev-positive">${rec.expected_value}</div>
                    </div>
                    <div style="margin: 15px 0;">
                        <h4 style="color: #fbbf24;">${rec.recommendation}</h4>
                        <p><strong>Odds:</strong> ${rec.odds} | <strong>Confidence:</strong> ${rec.confidence}</p>
                        <p><strong>Stake:</strong> ${rec.stake_suggestion} | <strong>Risk:</strong> ${rec.risk_level}</p>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.2); padding: 10px; border-radius: 8px; border-left: 4px solid #10b981;">
                        <strong>Reasoning:</strong> ${rec.reasoning}
                    </div>
                </div>
            `).join('');
        }

        function loadTrendsTab() {
            const trendsDiv = document.getElementById('formTrends');
            
            if (!bettingIntelligence || !bettingIntelligence.recent_trends) return;

            const trends = bettingIntelligence.recent_trends;
            trendsDiv.innerHTML = `
                <div class="market-grid">
                    <div class="market-card">
                        <h4 style="color: #fbbf24;">📊 Recent Performance</h4>
                        <div class="market-stat">
                            <div class="value">${trends.last_5_matches_avg}</div>
                            <div class="label">Last 5 Matches Average</div>
                        </div>
                    </div>
                    
                    <div class="market-card">
                        <h4 style="color: #fbbf24;">⚡ Powerplay Form</h4>
                        <div class="market-stat">
                            <div class="value" style="color: ${trends.powerplay_performance === 'Improving' ? '#10b981' : '#ef4444'}">${trends.powerplay_performance}</div>
                            <div class="label">Trend Direction</div>
                        </div>
                    </div>
                    
                    <div class="market-card">
                        <h4 style="color: #fbbf24;">💀 Death Overs</h4>
                        <div class="market-stat">
                            <div class="value" style="color: ${trends.death_overs_performance === 'Strong' ? '#10b981' : '#ef4444'}">${trends.death_overs_performance}</div>
                            <div class="label">Performance Level</div>
                        </div>
                    </div>
                    
                    <div class="market-card">
                        <h4 style="color: #fbbf24;">🏃‍♂️ vs Pace</h4>
                        <div class="market-stat">
                            <div class="value" style="color: ${trends.vs_pace_trend === 'Positive' ? '#10b981' : '#ef4444'}">${trends.vs_pace_trend}</div>
                            <div class="label">Recent Trend</div>
                        </div>
                    </div>
                    
                    <div class="market-card">
                        <h4 style="color: #fbbf24;">🌀 vs Spin</h4>
                        <div class="market-stat">
                            <div class="value" style="color: ${trends.vs_spin_trend === 'Positive' ? '#10b981' : '#ef4444'}">${trends.vs_spin_trend}</div>
                            <div class="label">Recent Trend</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function openAIChat() {
            console.log('🤖 Opening AI chat...');
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.style.display = 'block';
                console.log('✅ Chat container should be visible now');
            } else {
                console.error('❌ Chat container not found!');
            }
        }

        function closeAIChat() {
            document.getElementById('chatContainer').style.display = 'none';
        }

        function askQuickQuestion(question) {
            // Add user message to chat
            addMessageToChat(question, 'user');
            
            // Open chat if not already open
            openAIChat();
            
            // Process the question
            processAIQuery(question);
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            addMessageToChat(message, 'user');
            
            // Show typing indicator
            addMessageToChat('Analyzing betting opportunities...', 'ai', true);
            
            await processAIQuery(message);
        }

        async function processAIQuery(query) {
            try {
                // Try to call the API
                const response = await fetch(`${API_BASE}/api/betting/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        player_name: currentPlayer.player_name,
                        query: query,
                        player_stats: currentPlayer
                    })
                });

                let aiResponse;
                if (response.ok) {
                    const data = await response.json();
                    aiResponse = data.response;
                } else {
                    // Fallback to mock response
                    aiResponse = generateMockAIResponse(query);
                }

                // Remove typing indicator and add real response
                removeTypingIndicator();
                addMessageToChat(aiResponse, 'ai');

            } catch (error) {
                console.error('AI query failed:', error);
                removeTypingIndicator();
                addMessageToChat(generateMockAIResponse(query), 'ai');
            }
        }

        function generateMockAIResponse(query) {
            const queryLower = query.toLowerCase();
            
            if (queryLower.includes('runs') || queryLower.includes('score')) {
                return `🏏 **Runs Analysis for ${currentPlayer.player_name}**\n\n**Best Opportunity**: Over 25.5 runs at 1.85\n• Our Model: 65.8% chance of going over\n• Market Price: 54.1% implied probability\n• Expected Value: +12.3%\n\n**Form Context**: Recent form rating of 72/100 with last 5 matches averaging 28.4 runs. **Risk Assessment**: Medium (σ=15.2)`;
            }
            
            if (queryLower.includes('boundaries') || queryLower.includes('4s') || queryLower.includes('6s')) {
                return `🎯 **Boundaries Analysis**\n\nOver 4.5 boundaries market shows **negative EV (-6.5%)**. Market is overvaluing boundary potential.\n\n**Recommendation**: Consider LAYING or AVOIDING this market.\n• Current odds: 2.10\n• Our fair value: 1.95\n• Recent boundary rate: Below average`;
            }
            
            if (queryLower.includes('recommend') || queryLower.includes('bet')) {
                return `💰 **Top Betting Recommendation**\n\n**BACK Over 25.5 runs at 1.85**\n• Expected Value: +12.3%\n• Confidence: High\n• Suggested Stake: Medium (1-2% bankroll)\n\n**Reasoning**: Excellent recent form (+15% edge), consistent performer (low risk), market undervaluing probability\n\n**Risk Level**: Low (volatility σ=15.2)`;
            }
            
            return `📊 **Betting Intelligence Summary**\n\n**Current Form & Risk**:\n• Form Rating: 72/100\n• Consistency: 78.5/100\n• Volatility: 15.2 (Medium Risk)\n\n**Market Opportunities**:\n• 2 positive EV markets identified\n• Best EV: +12.3%\n• Total Volume: £305,000\n\n**Ask me specifically about**: runs, boundaries, strike rate, form trends, or betting recommendations!`;
        }

        function addMessageToChat(message, sender, isTyping = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (isTyping) {
                messageDiv.id = 'typingIndicator';
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${message.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bettingModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
