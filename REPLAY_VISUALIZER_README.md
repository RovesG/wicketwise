# 🏏 WicketWise Match Replay Visualizer

Interactive Streamlit-based cricket match replay system with ball-by-ball analysis, predictions, and betting insights.

## 📋 Overview

The Replay Visualizer is a comprehensive tool for analyzing cricket match predictions generated by the WicketWise system. It provides:

- **Ball-by-ball replay** with actual vs predicted outcomes
- **Win probability progression** throughout the match
- **Betting decision analysis** with value bet identification
- **Interactive filtering** by player, phase, and over range
- **Color-coded visualizations** for easy interpretation
- **Prediction accuracy metrics** by match phase

## 🚀 Quick Start

### 1. Generate Predictions Data

First, generate evaluation predictions using the trained model:

```bash
python3 eval.py --checkpoint checkpoints/best_model.pth --output eval_predictions.csv
```

### 2. Launch the Visualizer

```bash
# Using the demo script (recommended)
python3 demo_replay_visualizer.py

# Or directly with Streamlit
streamlit run wicketwise/replay_visualizer.py
```

### 3. Load Data

- **Option A**: Upload your `eval_predictions.csv` file via the sidebar
- **Option B**: Enter the file path in the sidebar input field

## 📊 Features

### Match Navigation
- **Match Selector**: Choose from available matches
- **Ball Slider**: Navigate through balls with a slider
- **Previous/Next Buttons**: Step through balls one by one

### Ball-by-Ball Analysis
- **Actual Outcome**: Color-coded actual ball result
- **Predicted Outcome**: Model prediction with accuracy indicator
- **Win Probability**: Current team win probability
- **Betting Signal**: Value bet, no bet, or risk alert

### Interactive Filters
- **Player Filters**: Filter by specific batter or bowler
- **Phase Filter**: Focus on powerplay, middle overs, or death overs
- **Over Range**: Analyze specific over ranges

### Visualizations
- **Win Probability Chart**: Line chart showing probability progression
- **Prediction Accuracy**: Accuracy metrics by match phase
- **Outcome Distribution**: Pie chart of actual outcomes
- **Betting Analysis**: Distribution of betting decisions

## 📁 Data Format

The visualizer expects a CSV file with the following columns:

### Required Columns
- `match_id`: Unique match identifier
- `ball_id`: Ball identifier (e.g., "1.1", "2.3")
- `actual_runs`: Actual runs scored (0-6 or wicket indicator)
- `predicted_runs_class`: Predicted outcome class
- `win_prob`: Win probability (0.0 to 1.0)
- `odds_mispricing`: Betting odds mispricing value
- `phase`: Match phase (powerplay, middle_overs, death_overs)
- `batter_id`: Batter identifier
- `bowler_id`: Bowler identifier

### Optional Columns
- `predicted_runs_0` to `predicted_runs_6`: Probability for each outcome
- `predicted_wicket`: Wicket probability
- `actual_win_prob`: Ground truth win probability
- `actual_mispricing`: Ground truth mispricing

## 🎨 Color Coding

### Outcome Colors
- **0 Runs**: Light gray
- **1 Run**: Light blue
- **2 Runs**: Blue
- **3 Runs**: Medium blue
- **4 Runs**: Bright blue
- **6 Runs**: Dark blue
- **Wicket**: Red

### Prediction Accuracy
- **Correct**: Green border
- **Incorrect**: Red border

### Betting Signals
- **Value Bet**: Green (mispricing > 0.15 & win prob > 0.6)
- **No Bet**: Gray (neutral conditions)
- **Risk Alert**: Red (mispricing < -0.15 or win prob < 0.2)

## 🔧 Usage Examples

### Basic Usage
```python
from wicketwise.replay_visualizer import ReplayVisualizer

# Initialize visualizer
visualizer = ReplayVisualizer()

# Load data
success = visualizer.load_data("eval_predictions.csv")

if success:
    print(f"Loaded {len(visualizer.matches)} matches")
    print(f"Total balls: {len(visualizer.data)}")
```

### Programmatic Analysis
```python
# Get match data
match_data = visualizer.data[visualizer.data['match_id'] == 'match_001']

# Calculate accuracy
accuracy = match_data['prediction_correct'].mean()
print(f"Prediction accuracy: {accuracy:.2%}")

# Analyze betting decisions
betting_dist = match_data['betting_decision'].value_counts()
print(f"Betting decisions: {betting_dist}")
```

## 📈 Performance Metrics

The visualizer automatically calculates:

- **Overall Accuracy**: Percentage of correct predictions
- **Phase-wise Accuracy**: Accuracy by match phase
- **Betting Metrics**: Distribution of betting decisions
- **Win Probability Trends**: Progression throughout match

## 🛠️ Configuration

### Betting Logic
Customize betting decision thresholds:

```python
def _generate_betting_decision(self, row):
    mispricing = row['odds_mispricing']
    win_prob = row['win_prob']
    
    # Customize these thresholds
    if mispricing > 0.15 and win_prob > 0.6:
        return "value_bet"
    elif mispricing < -0.15 or win_prob < 0.2:
        return "risk_alert"
    else:
        return "no_bet"
```

### Color Themes
Modify color schemes in the `__init__` method:

```python
self.outcome_colors = {
    "0_runs": "#E8E8E8",
    "wicket": "#FF4444",
    # ... customize colors
}
```

## 🧪 Testing

Run the test suite:

```bash
python3 -m pytest tests/test_replay_visualizer.py -v
```

The test suite includes:
- Data loading and validation
- Prediction processing
- Filter functionality
- Integration testing with sample data

## 📁 File Structure

```
wicketwise/
├── replay_visualizer.py          # Main visualizer module
├── __init__.py                   # Package initialization
└── core/                         # Core functionality
    ├── data_ingestor.py
    ├── feature_generator.py
    └── innings_predictor.py

tests/
└── test_replay_visualizer.py     # Test suite

sample_eval_predictions.csv       # Sample data
demo_replay_visualizer.py         # Demo script
```

## 🔍 Troubleshooting

### Common Issues

1. **File Not Found Error**
   ```bash
   # Ensure file path is correct
   ls -la eval_predictions.csv
   ```

2. **Missing Columns Error**
   ```bash
   # Check CSV format
   head -1 eval_predictions.csv
   ```

3. **Streamlit Import Error**
   ```bash
   # Install Streamlit
   pip install streamlit
   ```

### Debug Mode
Enable debug logging:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 🚀 Advanced Usage

### Custom Visualizations
Extend the visualizer with custom charts:

```python
class CustomReplayVisualizer(ReplayVisualizer):
    def render_custom_chart(self, match_data):
        # Add your custom visualization
        pass
```

### Batch Analysis
Analyze multiple matches:

```python
for match_id in visualizer.matches:
    match_data = visualizer.data[visualizer.data['match_id'] == match_id]
    accuracy = match_data['prediction_correct'].mean()
    print(f"Match {match_id}: {accuracy:.2%} accuracy")
```

## 📚 API Reference

### ReplayVisualizer Class

#### Methods
- `load_data(csv_path)`: Load predictions from CSV
- `render_match_selector()`: Render match selection UI
- `render_ball_navigation(match_data)`: Render ball navigation
- `render_ball_details(ball_data)`: Display ball information
- `render_filters(match_data)`: Apply data filters
- `render_win_probability_chart()`: Show win probability
- `render_prediction_accuracy_chart()`: Show accuracy metrics
- `render_betting_analysis()`: Show betting insights

#### Properties
- `data`: Processed match data DataFrame
- `matches`: List of available match IDs
- `outcome_colors`: Color mapping for outcomes
- `betting_colors`: Color mapping for betting decisions

## 🎯 Future Enhancements

- **Real-time Updates**: Live match replay
- **Export Functionality**: Save charts and reports
- **Advanced Filters**: More granular filtering options
- **Comparison Mode**: Compare multiple matches
- **Performance Metrics**: Detailed model performance analysis

## 📞 Support

For issues or questions:
1. Check the test suite for examples
2. Review the sample data format
3. Ensure all dependencies are installed
4. Check the console for error messages

## 📄 License

This module is part of the WicketWise cricket analytics platform. 