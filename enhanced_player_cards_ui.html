<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Enhanced Dynamic Player Cards - Cricket Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .player-card {
            transition: all 0.3s ease;
            max-width: 500px;
        }
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .real-data-indicator {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mock-data-indicator {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .persona-explanation {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }
        
        .format-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        
        .format-stat {
            background: #f3f4f6;
            padding: 6px 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .bowling-section {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            margin-top: 12px;
            border-radius: 6px;
        }
        
        .batting-section {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin-top: 12px;
            border-radius: 6px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            üèè Enhanced Dynamic Player Cards
        </h1>
        
        <!-- Persona Border Explanation -->
        <div class="persona-explanation text-center">
            <strong>üé® Border Colors Explained:</strong>
            <span class="mx-4">üü† Orange = Betting Analysis</span>
            <span class="mx-4">üîµ Blue = Commentary</span>
            <span class="mx-4">üü¢ Green = Coaching</span>
            <span class="mx-4">üî¥ Red = Fantasy</span>
        </div>
        
        <!-- Player Search -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1 relative">
                    <input 
                        type="text" 
                        id="playerSearch" 
                        placeholder="Enter player name (e.g., Virat Kohli, MS Dhoni)"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <div id="autocompleteDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                </div>
                <select id="personaSelect" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="betting">üé∞ Betting Analysis</option>
                    <option value="commentary">üì∫ Commentary</option>
                    <option value="coaching">üèÜ Coaching</option>
                    <option value="fantasy">‚ö° Fantasy</option>
                </select>
                <button 
                    id="generateBtn" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold"
                >
                    Generate Card
                </button>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Generating player card...</p>
        </div>
        
        <!-- Cards Container -->
        <div id="cardsContainer" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            <!-- Cards will be inserted here -->
        </div>
        
        <!-- Test Buttons -->
        <div class="mt-8 text-center">
            <h3 class="text-lg font-semibold mb-4">Quick Tests:</h3>
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="testPlayer('MS Dhoni', 'betting')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    MS Dhoni (Betting)
                </button>
                <button onclick="testPlayer('Virat Kohli', 'commentary')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Virat Kohli (Commentary)
                </button>
                <button onclick="testPlayer('Rohit Sharma', 'coaching')" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    Rohit Sharma (Coaching)
                </button>
                <button onclick="testPlayer('FAKE_PLAYER', 'fantasy')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Fake Player (Should show zeros)
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5005';
        let autocompleteTimeout;
        let systemConnected = true;

        // Initialize the UI
        document.addEventListener('DOMContentLoaded', function() {
            initializeUI();
            checkSystemHealth();
        });

        function initializeUI() {
            const playerSearch = document.getElementById('playerSearch');
            const generateBtn = document.getElementById('generateBtn');
            const personaSelect = document.getElementById('personaSelect');

            // Auto-complete functionality
            playerSearch.addEventListener('input', handlePlayerSearch);
            playerSearch.addEventListener('blur', () => {
                setTimeout(hideAutocomplete, 200); // Delay to allow click
            });

            // Generate card button
            generateBtn.addEventListener('click', generatePlayerCard);
            
            // Enter key to generate card
            playerSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    hideAutocomplete();
                    generatePlayerCard();
                }
            });
        }

        async function checkSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/cards/health`);
                const data = await response.json();
                systemConnected = data.status === 'healthy';
                console.log('üè• System Health:', data);
            } catch (error) {
                console.error('‚ùå System health check failed:', error);
                systemConnected = false;
            }
        }

        function handlePlayerSearch(e) {
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                hideAutocomplete();
                return;
            }
            
            // Debounce the search
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => {
                if (systemConnected) {
                    getRealAutocompleteSuggestions(query);
                } else {
                    getFallbackAutocompleteSuggestions(query);
                }
            }, 200);
        }
        
        async function getRealAutocompleteSuggestions(query) {
            try {
                const response = await fetch(`${API_BASE}/api/cards/autocomplete?partial=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();
                
                if (data.success) {
                    displayAutocompleteSuggestions(data.suggestions, data.source);
                }
            } catch (error) {
                console.error('Error getting real autocomplete:', error);
                getFallbackAutocompleteSuggestions(query);
            }
        }
        
        function getFallbackAutocompleteSuggestions(query) {
            // Fallback autocomplete
            const mockPlayers = [
                'Virat Kohli', 'MS Dhoni', 'Rohit Sharma', 'KL Rahul', 'Hardik Pandya',
                'A Kohli', 'Nikhil Kohli', 'Parth Kohli', 'Virandeep Singh', 'Virat Singh'
            ];
            
            const suggestions = mockPlayers.filter(player => 
                player.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);
            
            displayAutocompleteSuggestions(suggestions, 'fallback');
        }

        function displayAutocompleteSuggestions(suggestions, source) {
            const dropdown = document.getElementById('autocompleteDropdown');
            
            if (suggestions.length === 0) {
                hideAutocomplete();
                return;
            }
            
            const html = suggestions.map(suggestion => `
                <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                     onclick="selectPlayer('${suggestion}')">
                    ${suggestion}
                </div>
            `).join('');
            
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function selectPlayer(playerName) {
            document.getElementById('playerSearch').value = playerName;
            hideAutocomplete();
        }

        function hideAutocomplete() {
            document.getElementById('autocompleteDropdown').classList.add('hidden');
        }

        async function generatePlayerCard() {
            const playerName = document.getElementById('playerSearch').value.trim();
            const persona = document.getElementById('personaSelect').value;
            
            if (!playerName) {
                alert('Please enter a player name');
                return;
            }
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            
            try {
                if (systemConnected) {
                    await generateRealPlayerCard(playerName, persona);
                } else {
                    await generateFallbackPlayerCard(playerName, persona);
                }
            } catch (error) {
                console.error('Error generating card:', error);
                alert('Failed to generate player card. Please try again.');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        async function generateRealPlayerCard(playerName, persona) {
            const response = await fetch(`${API_BASE}/api/cards/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    player_name: playerName,
                    persona: persona
                })
            });

            const data = await response.json();
            
            if (data.success) {
                console.log('üé¥ Card API Response:', data);
                displayPlayerCard(data.card_data, persona, {
                    realDataUsed: data.real_data_used,
                    gnnInsightsUsed: data.gnn_insights_used
                });
            } else {
                throw new Error(data.error || 'Failed to generate card');
            }
        }

        function testPlayer(playerName, persona) {
            document.getElementById('playerSearch').value = playerName;
            document.getElementById('personaSelect').value = persona;
            generatePlayerCard();
        }

        function displayPlayerCard(cardData, persona, metadata = {}) {
            const container = document.getElementById('cardsContainer');
            
            // Debug the metadata
            console.log('üîç DEBUG: Card metadata:', metadata);
            console.log('üîç DEBUG: Card data sources:', cardData.data_sources || cardData.dataSources);
            console.log('üîç DEBUG: metadata.realDataUsed:', metadata.realDataUsed);
            console.log('üîç DEBUG: cardData contains Real_KG_Data:', (cardData.data_sources || []).includes('Real_KG_Data'));
            
            // Check multiple ways to determine if real data is used
            const isRealData = metadata.realDataUsed || 
                              (cardData.data_sources && cardData.data_sources.includes('Real_KG_Data')) ||
                              (cardData.source === 'Real_KG_Data');
            
            console.log('üîç DEBUG: Final isRealData decision:', isRealData);
            
            const dataSourceBadge = isRealData ? 
                '<span class="real-data-indicator">‚úÖ REAL KG DATA</span>' :
                '<span class="mock-data-indicator">‚ö†Ô∏è MOCK DATA (ALL ZEROS)</span>';
            
            const gnnBadge = metadata.gnnInsightsUsed ? 
                '<span class="real-data-indicator ml-1">üß† GNN INSIGHTS</span>' : '';

            // Format stats display
            const formatStatsHtml = cardData.format_stats ? `
                <div class="format-stats">
                    <div class="format-stat">
                        <div class="text-xs text-gray-600">Overall SR</div>
                        <div class="font-semibold">${cardData.format_stats.overall_sr?.toFixed(1) || '0.0'}</div>
                    </div>
                    <div class="format-stat">
                        <div class="text-xs text-gray-600">Powerplay SR</div>
                        <div class="font-semibold">${cardData.format_stats.powerplay_sr?.toFixed(1) || '0.0'}</div>
                    </div>
                    <div class="format-stat">
                        <div class="text-xs text-gray-600">Death Overs SR</div>
                        <div class="font-semibold">${cardData.format_stats.death_overs_sr?.toFixed(1) || '0.0'}</div>
                    </div>
                    <div class="format-stat">
                        <div class="text-xs text-gray-600">vs Pace SR</div>
                        <div class="font-semibold">${cardData.format_stats.vs_pace_sr?.toFixed(1) || '0.0'}</div>
                    </div>
                </div>
            ` : '';

            // Bowling stats section
            const bowlingStatsHtml = cardData.bowling_stats && (cardData.bowling_stats.balls > 0 || cardData.bowling_stats.wickets > 0) ? `
                <div class="bowling-section">
                    <h4 class="font-semibold text-amber-800 mb-2">üé≥ Bowling Statistics</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Balls:</span>
                            <span class="font-semibold ml-2">${cardData.bowling_stats.balls || 0}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Wickets:</span>
                            <span class="font-semibold ml-2">${cardData.bowling_stats.wickets || 0}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Economy:</span>
                            <span class="font-semibold ml-2">${cardData.bowling_stats.economy?.toFixed(2) || '0.00'}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Bowling Avg:</span>
                            <span class="font-semibold ml-2">${cardData.bowling_stats.bowling_avg?.toFixed(2) || '0.00'}</span>
                        </div>
                    </div>
                </div>
            ` : '';
            
            const cardHtml = `
                <div class="player-card bg-white rounded-lg shadow-lg overflow-hidden border-l-4 ${getPersonaBorderColor(persona)}">
                    <!-- Card Header -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-4">
                        <div class="flex items-center space-x-4">
                            <img src="${cardData.profile_image_url || cardData.profileImageUrl}" 
                                 alt="${cardData.player_name || cardData.playerName}"
                                 class="w-16 h-16 rounded-full border-2 border-white object-cover"
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(cardData.player_name || cardData.playerName)}&background=0d47a1&color=fff&size=150'">
                            <div>
                                <h3 class="text-xl font-bold">${cardData.player_name || cardData.playerName}</h3>
                                <p class="text-gray-300 text-sm">${getPersonaLabel(persona)} Analysis</p>
                                <p class="text-gray-400 text-xs">Role: ${cardData.primary_role || 'Unknown'}</p>
                                <div class="flex items-center mt-1 flex-wrap gap-1">
                                    ${dataSourceBadge}
                                    ${gnnBadge}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="p-4">
                        <!-- Batting Section -->
                        <div class="batting-section">
                            <h4 class="font-semibold text-blue-800 mb-2">üèè Batting Statistics</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                                <div>
                                    <span class="text-gray-600">Matches:</span>
                                    <span class="font-semibold ml-2">${cardData.matches_played || 0}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Average:</span>
                                    <span class="font-semibold ml-2">${cardData.batting_avg?.toFixed(2) || '0.00'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Strike Rate:</span>
                                    <span class="font-semibold ml-2">${cardData.strike_rate?.toFixed(1) || '0.0'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Teams:</span>
                                    <span class="font-semibold ml-2">${(cardData.teams || []).length}</span>
                                </div>
                            </div>
                            
                            <!-- Format-specific Strike Rates -->
                            ${formatStatsHtml}
                        </div>

                        <!-- Bowling Section (if applicable) -->
                        ${bowlingStatsHtml}

                        <!-- Teams -->
                        ${(cardData.teams && cardData.teams.length > 0) ? `
                            <div class="mt-4">
                                <h4 class="font-semibold text-gray-800 mb-2">üèüÔ∏è Teams</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${cardData.teams.slice(0, 3).map(team => `
                                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${team}</span>
                                    `).join('')}
                                    ${cardData.teams.length > 3 ? `<span class="text-xs text-gray-500">+${cardData.teams.length - 3} more</span>` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Strengths (if available) -->
                        ${(cardData.strengths && cardData.strengths.length > 0) ? `
                            <div class="mt-4">
                                <h4 class="font-semibold text-gray-800 mb-2">üí™ Strengths</h4>
                                <div class="text-sm text-gray-600">
                                    ${cardData.strengths.slice(0, 2).join(', ')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Timestamp -->
                        <div class="mt-4 pt-3 border-t border-gray-200 text-xs text-gray-500">
                            Generated: ${new Date(cardData.last_updated || Date.now()).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
            
            // Add the card to the beginning of the container
            container.insertAdjacentHTML('afterbegin', cardHtml);
        }

        function getPersonaBorderColor(persona) {
            const colors = {
                'betting': 'border-orange-500',
                'commentary': 'border-blue-500', 
                'coaching': 'border-green-500',
                'fantasy': 'border-red-500'
            };
            return colors[persona] || 'border-gray-500';
        }

        function getPersonaLabel(persona) {
            const labels = {
                'betting': 'Betting',
                'commentary': 'Commentary',
                'coaching': 'Coaching', 
                'fantasy': 'Fantasy'
            };
            return labels[persona] || 'General';
        }
    </script>
</body>
</html>
